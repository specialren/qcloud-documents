## 叮咚买菜业务介绍
叮咚买菜创立于2017年5月，是一站式自营生鲜平台，通过产地直采、前置仓配货、 配送到家的生活服务，为用户提供便捷、丰富、高品质的生鲜消费体验，服务范围覆盖上海、北京、深圳、杭州、苏州等城市。

## 需求分析
叮咚买菜2021年平均月交易用户数量同比增长120%，达到千万级别，这对高并发和数据一致性提出了更高要求。叮咚买菜自建 MongoDB 集群在日常处理业务时，频繁不定期遇到一些性能瓶颈，包括读从超时、集群频繁抖动等。在业务高峰期这些问题更为突出，延迟明显增加。叮咚自建 MongoDB 3.2 升级更高版本时，又遇到 Session 定期刷新引起的集群周期性性能抖动的问题。同时，自建数据库运维难度非常大，耗时又费力。叮咚数据团队基于自建成本、物理资源不足等原因，经过综合评估，决定把 MongoDB 数据迁移到腾讯云数据库 MongoDB。 

## 解决方案
### 选择版本
叮咚自建 MongoDB 因历史原因一直保持在官方 MongoDB 3.2版本，在一些场景存在性能瓶颈，例如用户主从读写分离时会遇到读超时等问题。考虑到用户对性能要求较高，同时结合叮咚买菜具体业务场景、集群部署方式、内核版本、客户端版本、客户端 Driver 类型等，叮咚买菜最终选择腾讯云数据库 MongoDB 4.0 版本。相比自建，云上 MongoDB 集群性能更好，选用更低规格实例，最大化节省成本。

#### 集群架构
叮咚买菜主要是副本集集群，且对更高版本分布式事务、多字段 hash 片键支持这些新功能需求并不强烈，同时综合集群稳定性考虑，最终选择4.0版本副本集架构。 

#### 性能方面
- MongoDB 4.0 高版本引入了非阻塞的从节点读（Non-Blocking Secondary Reads），彻底解决了3.2版本从节点批量重放 Oplog 时引起的读从节点读阻塞问题。并且4.0版本写性能方面也更具优势。
- 腾讯云数据库 MongoDB 团队针对用户 Session 等问题进行内核定制化优化，解决 Session 周期性抖动问题。
- 4.0版本相比3.2版本，增加分片扩容后的数据迁移采用更好的并发迁移策略，扩容数据迁移速率更高。 

#### 存储引擎
MongoDB 4.0 对存储引擎做了很多优化，例如 Cache 脏数据淘汰、锁粒度、更全的引擎参数调整支持等，解决了低版本后台加索引、大流量读写等引起的客户端访问阻塞问题。 

#### 智能运维
腾讯云数据库 MongoDB 提供完善的监控告警、数据备份回档、跨地域容灾、实时巡检、7 x 24小时在线服务等，实例使用过程中完全透明。提供20余项的自动化监控指标，多维度监控，自动故障预警，无须人力值守，大幅简化了运维难题。

####  客户端兼容性
叮咚技术团队经过验证，确认客户端版本完全兼容 MongoDB 4.0 内核，客户端代码无需任何改造。常用客户端 Driver 与 MongoDB 内核版本兼容性，请参见 [java](https://mp.weixin.qq.com/s/tO7dMzBkapX3YZbZzdGiig?vid=1688856270234562&deviceid=b0dd0d46-cea7-4960-b780-452e842760cb&version=4.0.20.6009&platform=win)、 [golang](https://www.mongodb.com/docs/drivers/go/current/compatibility/)、 [php]( https://docs.mongodb.com/drivers/php/)、[其他]( https://docs.mongodb.com/drivers/)。

### 迁移方案
叮咚业务 MongoDB 存储了部分重要数据，不允许数据丢失及混乱，对数据一致性要求极高。为了防止版本兼容异常、业务访问阻塞，以及极端情况下数据丢失、数据混乱、数据不一致等问题， 业务流量从源叮咚自建 MongoDB 3.2 副本集群迁移至腾讯云数据库 MongoDB 4.0 后，同时直接回滚到腾讯云数据库 MongoDB 3.2 版本。回滚集群和源叮咚自建集群版本一致，通过 [数据传输服务 DTS](https://cloud.tencent.com/document/product/240/37646) 实时同步，保证回滚流程数据不混乱、不冲突、不丢失，保证切割过程异常时快速回滚。 
![](https://qcloudimg.tencent-cloud.cn/raw/e0339527a7d24fbfcd77c0f149a29095.png)

## 项目成果
通过梳理拆分，把一些核心的复杂 MongoDB 集群，垂直拆分为多个集群，耦合性降低。集群稳定性提高，上云前业务遇到的各种 MongoDB 访问毛刺和抖动问题得到了彻底解决。
与自建 MongoDB 相比，腾讯云数据库 MongoDB 性能更出色，能够充分利用云的弹性扩容能力，无需预留过多硬件资源，大幅节省了成本。腾讯云技术团队可以通过大规模云上实践经验帮助客户分析定位解决 MongoDB 深层次技术问题。 

